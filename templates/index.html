<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-means ë¶„ì„ í”Œë«í¼</title>
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; }
        body { font-family: 'Malgun Gothic', 'NanumGothic', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1f2937; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #6b7280; font-size: 14px; margin-bottom: 30px; }
        
        /* ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #e5e7eb; border-radius: 10px; background: #fafafa; }
        .section-title { font-weight: bold; margin-bottom: 15px; color: var(--primary); font-size: 1.2em; }
        
        /* ì»¨íŠ¸ë¡¤ ê·¸ë¦¬ë“œ */
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        /* ì…ë ¥ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        select, input[type="number"], input[type="file"] {
            width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box;
        }
        
        /* ë²„íŠ¼ */
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 24px;
            border-radius: 6px; cursor: pointer; font-size: 16px; width: 100%; margin-top: 20px;
            transition: background 0.2s;
        }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }

        /* ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” */
        .table-container { overflow-x: auto; margin-top: 10px; max-height: 300px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 8px; border: 1px solid #e5e7eb; text-align: left; }
        th { background: #f9fafb; font-weight: 600; white-space: nowrap; position: sticky; top: 0; }
        
        /* ê²°ê³¼ ì˜ì—­ */
        #resultArea { display: none; margin-top: 30px; border-top: 2px dashed #e5e7eb; padding-top: 30px; }
        .chart-img { width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stats-box { display: flex; gap: 20px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .stat-card { background: #f0f9ff; padding: 15px; border-radius: 8px; text-align: center; min-width: 120px; }
        .info-box { background: #e0f2fe; border-left: 4px solid #0284c7; padding: 12px; margin-top: 15px; border-radius: 4px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ë°ì´í„° K-means ë¶„ì„ê¸°</h1>
        <p class="subtitle">ë°ì´í„° ì—…ë¡œë“œ â†’ Kê°’ ì„¤ì • â†’ ìë™ ì •ê·œí™” â†’ K-means ìˆ˜í–‰ â†’ 2ê°€ì§€ ê·¸ë˜í”„ ì¶œë ¥</p>

        <div class="section">
            <div class="section-title">1ï¸âƒ£ ë°ì´í„° ì—…ë¡œë“œ</div>
            <input type="file" id="fileInput" accept=".csv">
            
            <div id="previewArea" style="display: none;">
                <p style="margin-top: 15px;">ğŸ“‹ <strong>ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ 5í–‰)</strong> - ì´ <span id="totalRows">0</span>í–‰</p>
                <div class="table-container">
                    <table id="previewTable"></table>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">2ï¸âƒ£ ë¶„ì„ ì˜µì…˜ ì„¤ì •</div>
            <div class="controls">
                <div>
                    <label>Xì¶• ì»¬ëŸ¼ (ê·¸ë˜í”„1 ì‹œê°í™”ìš©)</label>
                    <select id="xAxis"></select>
                </div>
                <div>
                    <label>Yì¶• ì»¬ëŸ¼ (ê·¸ë˜í”„1 ì‹œê°í™”ìš©)</label>
                    <select id="yAxis"></select>
                </div>
                <div>
                    <label>êµ°ì§‘ ìˆ˜ (K)</label>
                    <input type="number" id="kValue" value="3" min="2" max="10">
                </div>
            </div>
            
            <div class="info-box">
                â„¹ï¸ <strong>ìë™ ì ìš© í•­ëª©:</strong> 
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li><strong>ì •ê·œí™”</strong>: ëª¨ë“  ìˆ˜ì¹˜í˜• ë°ì´í„°ë¥¼ í‘œì¤€í™” (í‰ê· =0, í‘œì¤€í¸ì°¨=1)</li>
                    <li><strong>ê·¸ë˜í”„1</strong>: ì›ë³¸ X,Yì¶•ìœ¼ë¡œ êµ°ì§‘ ê²°ê³¼ í‘œì‹œ</li>
                    <li><strong>ê·¸ë˜í”„2</strong>: PCA 2ì°¨ì›ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì „ì²´ ë°ì´í„° íŒ¨í„´ í‘œì‹œ</li>
                </ul>
            </div>
            
            <button class="btn" id="analyzeBtn" onclick="analyzeData()" disabled>ğŸš€ ë¶„ì„ ì‹œì‘</button>
        </div>

        <div id="resultArea">
            <h2 style="text-align: center;">ğŸ“ˆ ë¶„ì„ ê²°ê³¼</h2>
            <img id="resultImage" class="chart-img" alt="Result Chart">
            
            <div style="margin-top: 30px;">
                <h3 style="color: #1f2937; margin-bottom: 15px;">ğŸ“Š êµ°ì§‘ ë¶„ì„ ìš”ì•½</h3>
                
                <!-- êµ°ì§‘ë³„ ë°ì´í„° ê°œìˆ˜ -->
                <div class="stats-box" id="statsBox"></div>
                
                <!-- ì „ì²´ ìš”ì•½ ì •ë³´ -->
                <div id="summaryInfo" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;"></div>
            </div>
            
            <div class="info-box" style="margin-top: 30px;">
                <strong>ğŸ“– ê²°ê³¼ í•´ì„ ê°€ì´ë“œ</strong><br><br>
                
                <strong>ğŸ”µ êµ°ì§‘(Cluster)ì´ë€?</strong><br>
                ë°ì´í„°ë¥¼ ìœ ì‚¬í•œ íŠ¹ì„±ë¼ë¦¬ ë¬¶ì€ ê·¸ë£¹ì…ë‹ˆë‹¤. ê°™ì€ ìƒ‰ìƒ = ê°™ì€ êµ°ì§‘<br><br>
                
                <strong>ğŸ“Š ê·¸ë˜í”„ ì„¤ëª…</strong><br>
                â€¢ <strong>ì™¼ìª½ ê·¸ë˜í”„:</strong> ì„ íƒí•œ X, Yì¶•ìœ¼ë¡œ ì›ë³¸ ë°ì´í„°ë¥¼ í‘œì‹œ (ì‹¤ì œ ê°’ìœ¼ë¡œ ì´í•´í•˜ê¸° ì‰¬ì›€)<br>
                â€¢ <strong>ì˜¤ë¥¸ìª½ ê·¸ë˜í”„:</strong> PCAë¡œ ì „ì²´ ë°ì´í„° íŒ¨í„´ì„ 2ì°¨ì›ìœ¼ë¡œ ì••ì¶• (ì „ì²´ êµ¬ì¡° íŒŒì•…)<br>
                â€¢ <strong>ë¹¨ê°„ X í‘œì‹œ:</strong> ê° êµ°ì§‘ì˜ ì¤‘ì‹¬ì  (í•´ë‹¹ êµ°ì§‘ì˜ í‰ê· ì ì¸ ìœ„ì¹˜)<br><br>
                
                <strong>ğŸ“ˆ í†µê³„ ìˆ˜ì¹˜ ì„¤ëª…</strong><br>
                â€¢ <strong>êµ°ì§‘ë³„ ë°ì´í„° ìˆ˜:</strong> ê° ê·¸ë£¹ì— ì†í•œ ë°ì´í„° ê°œìˆ˜<br>
                â€¢ <strong>ì „ì²´ ë°ì´í„° ìˆ˜:</strong> ë¶„ì„ì— ì‚¬ìš©ëœ ì´ ë°ì´í„° ê°œìˆ˜<br>
                â€¢ <strong>Inertia:</strong> êµ°ì§‘ ë‚´ ì‘ì§‘ë„ (ë‚®ì„ìˆ˜ë¡ ê·¸ë£¹ì´ ì˜ ë­‰ì³ìˆìŒ)<br>
                â€¢ <strong>ê°€ì¥ í°/ì‘ì€ êµ°ì§‘:</strong> ë°ì´í„° ë¶„í¬ì˜ ë¶ˆê· í˜• ì •ë„ í™•ì¸<br><br>
                
                <strong>ğŸ’¡ í™œìš© íŒ</strong><br>
                â€¢ Kê°’ì„ ë°”ê¿”ê°€ë©° ë¶„ì„í•˜ì—¬ ìµœì ì˜ êµ°ì§‘ ìˆ˜ë¥¼ ì°¾ì•„ë³´ì„¸ìš”<br>
                â€¢ ë‹¤ë¥¸ X, Yì¶• ì¡°í•©ìœ¼ë¡œ ë‹¤ì–‘í•œ ê°ë„ì—ì„œ ë°ì´í„°ë¥¼ ê´€ì°°í•˜ì„¸ìš”<br>
                â€¢ êµ°ì§‘ë³„ íŠ¹ì„±ì„ íŒŒì•…í•˜ì—¬ ì‹¤ë¬´ì— ì ìš©í•˜ì„¸ìš” (ì˜ˆ: ê³ ê° ì„¸ë¶„í™”, ì´ìƒì¹˜ íƒì§€)
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        let uploadedFile = null;

        // íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ìš”ì²­
        fileInput.addEventListener('change', async function(e) {
            if (!e.target.files[0]) return;
            uploadedFile = e.target.files[0];
            
            const formData = new FormData();
            formData.append('file', uploadedFile);

            try {
                const res = await fetch('/preview', { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    renderPreview(data);
                    updateSelects(data.columns);
                    document.getElementById('analyzeBtn').disabled = false;
                } else {
                    alert('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + data.error);
                }
            } catch (err) {
                alert('âŒ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ');
            }
        });

        // ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” ë Œë”ë§
        function renderPreview(data) {
            document.getElementById('previewArea').style.display = 'block';
            document.getElementById('totalRows').textContent = data.total_rows;
            
            const table = document.getElementById('previewTable');
            const records = data.preview_data;
            if (records.length === 0) return;

            // í—¤ë” ìƒì„±
            const headers = Object.keys(records[0]);
            let html = '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
            
            // ë°”ë”” ìƒì„±
            html += '<tbody>' + records.map(row => {
                return '<tr>' + headers.map(h => `<td>${row[h]}</td>`).join('') + '</tr>';
            }).join('') + '</tbody>';

            table.innerHTML = html;
        }

        // ì„ íƒ ìƒì(Xì¶•, Yì¶•) ì—…ë°ì´íŠ¸
        function updateSelects(columns) {
            const xSelect = document.getElementById('xAxis');
            const ySelect = document.getElementById('yAxis');
            
            const options = columns.map(col => `<option value="${col}">${col}</option>`).join('');
            
            xSelect.innerHTML = options;
            ySelect.innerHTML = options;

            // ê¸°ë³¸ê°’ ìë™ ì„ íƒ (ì„œë¡œ ë‹¤ë¥¸ ê°’ìœ¼ë¡œ)
            if (columns.length > 1) {
                ySelect.selectedIndex = 1;
            }
        }

        // ë¶„ì„ ìˆ˜í–‰
        async function analyzeData() {
            if (!uploadedFile) return;

            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            btn.textContent = 'â³ ë¶„ì„ ì¤‘... (ì •ê·œí™” + K-means + PCA)';

            const formData = new FormData();
            formData.append('file', uploadedFile);
            formData.append('k', document.getElementById('kValue').value);
            formData.append('x_axis', document.getElementById('xAxis').value);
            formData.append('y_axis', document.getElementById('yAxis').value);

            try {
                const res = await fetch('/analyze', { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('resultArea').style.display = 'block';
                    document.getElementById('resultImage').src = 'data:image/png;base64,' + data.plot_url;
                    
                    // í†µê³„ ê³„ì‚°
                    const clusterEntries = Object.entries(data.cluster_counts);
                    const totalData = clusterEntries.reduce((sum, [_, count]) => sum + count, 0);
                    const maxCluster = clusterEntries.reduce((max, curr) => curr[1] > max[1] ? curr : max);
                    const minCluster = clusterEntries.reduce((min, curr) => curr[1] < min[1] ? curr : min);
                    
                    // êµ°ì§‘ë³„ ë°ì´í„° ìˆ˜ í‘œì‹œ
                    const statsBox = document.getElementById('statsBox');
                    let statsHtml = clusterEntries.map(([cluster, count]) => {
                        const percentage = ((count / totalData) * 100).toFixed(1);
                        return `
                            <div class="stat-card">
                                <div style="font-size: 28px; font-weight: bold; color: #2563eb;">${count}ê°œ</div>
                                <div style="font-size: 14px; color: #666; margin-top: 5px;">Cluster ${cluster}</div>
                                <div style="font-size: 12px; color: #999; margin-top: 3px;">${percentage}%</div>
                            </div>
                        `;
                    }).join('');
                    
                    statsBox.innerHTML = statsHtml;
                    
                    // ì „ì²´ ìš”ì•½ ì •ë³´
                    const summaryInfo = document.getElementById('summaryInfo');
                    summaryInfo.innerHTML = `
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #22c55e;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ğŸ“¦ ì „ì²´ ë°ì´í„° ìˆ˜</div>
                            <div style="font-size: 24px; font-weight: bold; color: #16a34a;">${totalData}ê°œ</div>
                        </div>
                        
                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ğŸ“Š Inertia (ì‘ì§‘ë„)</div>
                            <div style="font-size: 24px; font-weight: bold; color: #d97706;">${data.inertia.toFixed(2)}</div>
                            <div style="font-size: 11px; color: #92400e; margin-top: 3px;">ë‚®ì„ìˆ˜ë¡ êµ°ì§‘ì´ ì˜ í˜•ì„±ë¨</div>
                        </div>
                        
                        <div style="background: #e0e7ff; padding: 15px; border-radius: 8px; border-left: 4px solid #6366f1;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">â¬†ï¸ ê°€ì¥ í° êµ°ì§‘</div>
                            <div style="font-size: 24px; font-weight: bold; color: #4f46e5;">Cluster ${maxCluster[0]}</div>
                            <div style="font-size: 11px; color: #4338ca; margin-top: 3px;">${maxCluster[1]}ê°œ (${((maxCluster[1]/totalData)*100).toFixed(1)}%)</div>
                        </div>
                        
                        <div style="background: #fce7f3; padding: 15px; border-radius: 8px; border-left: 4px solid #ec4899;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">â¬‡ï¸ ê°€ì¥ ì‘ì€ êµ°ì§‘</div>
                            <div style="font-size: 24px; font-weight: bold; color: #db2777;">Cluster ${minCluster[0]}</div>
                            <div style="font-size: 11px; color: #9f1239; margin-top: 3px;">${minCluster[1]}ê°œ (${((minCluster[1]/totalData)*100).toFixed(1)}%)</div>
                        </div>
                    `;
                    
                    // ìŠ¤í¬ë¡¤ ì´ë™
                    document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('âŒ ë¶„ì„ ì‹¤íŒ¨: ' + data.error);
                }
            } catch (err) {
                alert('âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ ë¶„ì„ ì‹œì‘';
            }
        }
    </script>
</body>
</html>